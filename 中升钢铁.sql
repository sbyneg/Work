
{"id": "1463033656385736706", "valid": 0, "plantCode": "zhongsheng", "createTime": "2021-11-23T14:36:20", "detailList": 
[
{"id": "1463033656398319623", "valid": 1, "ratioName": "billetIron", "createTime": "2021-11-23T14:36:20", "ratioValue": 98, "updateTime": "2021-11-23T14:36:20", "processDefinitionId": "1463033656385736706"}, 
{"id": "1463033656398319619", "valid": 1, "ratioName": "blastFurnaceIron", "createTime": "2021-11-23T14:36:20", "ratioValue": 0.5, "updateTime": "2021-11-23T14:36:20", "processDefinitionId": "1463033656385736706"},
{"id": "1463033656398319631", "valid": 1, "ratioName": "coalCoke", "createTime": "2021-11-23T14:36:20", "ratioValue": 85, "updateTime": "2021-11-23T14:36:20", "processDefinitionId": "1463033656385736706"},
{"id": "1463033656402513924", "valid": 1, "ratioName": "continuousCasting", "createTime": "2021-11-23T14:36:20", "ratioValue": 0.3, "updateTime": "2021-11-23T14:36:20", "processDefinitionId": "1463033656385736706"},
{"id": "1463033656398319620", "valid": 1, "ratioName": "converterIron", "createTime": "2021-11-23T14:36:20", "ratioValue": 7, "updateTime": "2021-11-23T14:36:20", "processDefinitionId": "1463033656385736706"},
{"id": "1463033656398319628", "valid": 1, "ratioName": "gradeIncreaseImpact", "createTime": "2021-11-23T14:36:20", "ratioValue": 1.25, "updateTime": "2021-11-23T14:36:20", "processDefinitionId": "1463033656385736706"},
{"id": "1463033656398319630", "valid": 1, "ratioName": "gradeMax", "createTime": "2021-11-23T14:36:20", "ratioValue": 60, "updateTime": "2021-11-23T14:36:20", "processDefinitionId": "1463033656385736706"},
{"id": "1463033656398319629", "valid": 1, "ratioName": "gradeMin", "createTime": "2021-11-23T14:36:20", "ratioValue": 53.5, "updateTime": "2021-11-23T14:36:20", "processDefinitionId": "1463033656385736706"},
{"id": "1463033656398319622", "valid": 1, "ratioName": "liquidIron", "createTime": "2021-11-23T14:36:20", "ratioValue": 94, "updateTime": "2021-11-23T14:36:20", "processDefinitionId": "1463033656385736706"},
{"id": "1463033656398319624", "valid": 1, "ratioName": "maxMaterialFeed", "createTime": "2021-11-23T14:36:20", "ratioValue": 9000, "updateTime": "2021-11-23T14:36:20", "processDefinitionId": "1463033656385736706"},
{"id": "1463033656394125313", "valid": 1, "ratioName": "mno", "createTime": "2021-11-23T14:36:20", "ratioValue": 70, "updateTime": "2021-11-23T14:36:20", "processDefinitionId": "1463033656385736706"},
{"id": "1463033656402513922", "valid": 1, "ratioName": "pelletizingDesulfuration", "createTime": "2021-11-23T14:36:20", "ratioValue": 85, "updateTime": "2021-11-23T14:36:20", "processDefinitionId": "1463033656385736706"},
{"id": "1463033656402513926", "valid": 1, "ratioName": "pelletizingReturnMine", "createTime": "2021-11-23T14:36:20", "ratioValue": 9, "updateTime": "2021-11-23T14:36:20", "processDefinitionId": "1463033656385736706"},
{"id": "1463033656398319626", "valid": 1, "ratioName": "referenceCoal", "createTime": "2021-11-23T14:36:20", "ratioValue": 145, "updateTime": "2021-11-30T15:38:33", "processDefinitionId": "1463033656385736706"},
{"id": "1463033656398319625", "valid": 1, "ratioName": "referenceCoke", "createTime": "2021-11-23T14:36:20", "ratioValue": 375, "updateTime": "2021-11-30T15:38:33", "processDefinitionId": "1463033656385736706"},
{"id": "1463033656398319627", "valid": 1, "ratioName": "referenceGrade", "createTime": "2021-11-23T14:36:20", "ratioValue": 57.5, "updateTime": "2021-11-23T14:36:20", "processDefinitionId": "1463033656385736706"},
{"id": "1463033656398319621", "valid": 1, "ratioName": "silicon", "createTime": "2021-11-23T14:36:20", "ratioValue": 0.3, "updateTime": "2021-11-23T14:36:20", "processDefinitionId": "1463033656385736706"},
{"id": "1463033656402513921", "valid": 1, "ratioName": "sinteringDesulfuration", "createTime": "2021-11-23T14:36:20", "ratioValue": 80, "updateTime": "2021-11-23T14:36:20", "processDefinitionId": "1463033656385736706"},
{"id": "1463033656402513925", "valid": 1, "ratioName": "sinteringReturnMine", "createTime": "2021-11-23T14:36:20", "ratioValue": 18, "updateTime": "2021-11-23T14:36:20", "processDefinitionId": "1463033656385736706"},
{"id": "1463033656398319618", "valid": 1, "ratioName": "slagImpurity", "createTime": "2021-11-23T14:36:20", "ratioValue": 2, "updateTime": "2021-11-23T14:36:20", "processDefinitionId": "1463033656385736706"},
{"id": "1463033656402513927", "valid": 1, "ratioName": "smeltingReturnMine", "createTime": "2021-11-23T14:36:20", "ratioValue": 15, "updateTime": "2021-11-23T14:36:20", "processDefinitionId": "1463033656385736706"},
{"id": "1463033656402513923", "valid": 1, "ratioName": "steelScrap", "createTime": "2021-11-23T14:36:20", "ratioValue": 2, "updateTime": "2021-11-23T14:36:20", "processDefinitionId": "1463033656385736706"},
{"id": "1463033656398319617", "valid": 1, "ratioName": "tio2", "createTime": "2021-11-23T14:36:20", "ratioValue": 25, "updateTime": "2021-11-23T14:36:20", "processDefinitionId": "1463033656385736706"}], 
"updateTime": "2021-11-24T18:28:47", "description": "真实数据，勿动", "particularYear": 2021, "productionName": "算法测试产品", "processConfigureModelList": 
[
{"id": "1463033656415096834", "valid": 1, "createTime": "2021-11-23T14:36:20", "updateTime": "2021-11-23T14:36:20", "processType": 1, "processDefinitionId": "1463033656385736706", "constraintConfigureId": "1463026548743344130", "constraintConfigureName": "算法真实烧结（勿删）"},
{"id": "1463033656415096835", "valid": 1, "createTime": "2021-11-23T14:36:20", "updateTime": "2021-11-23T14:36:20", "processType": 2, "processDefinitionId": "1463033656385736706", "constraintConfigureId": "1463029244376387586", "constraintConfigureName": "算法真实球团（勿删）"},
{"id": "1463033656415096836", "valid": 1, "createTime": "2021-11-23T14:36:20", "updateTime": "2021-11-23T14:36:20", "processType": 3, "processDefinitionId": "1463033656385736706", "constraintConfigureId": "1463032093227356162", "constraintConfigureName": "算法真实炼铁（勿删）"},
{"id": "1463033656415096837", "valid": 1, "createTime": "2021-11-23T14:36:20", "updateTime": "2021-11-23T14:36:20", "processType": 4, "processDefinitionId": "1463033656385736706", "constraintConfigureId": "1463032325654712321", "constraintConfigureName": "算法真实炼钢（勿删）"},
{"id": "1463033656415096838", "valid": 1, "createTime": "2021-11-23T14:36:20", "updateTime": "2021-11-23T14:36:20", "processType": 5, "processDefinitionId": "1463033656385736706"}]}
'$.detailList[17].ratioValue'

{"id": "1465639323887407107", "grade": 50.27, "sinter": 1, "freight": 0, "taxRate": 1.09, "shipName": "勿动！！！", "supplier": "1", "ironSmelt": 0, "pelletize": 0, "plantCode": "zhongsheng", "unitPrice": 100, "categoryId": "6", "steelSmelt": 0, "categoryCode": "SLUDGE",
 "materialDate": "2021-11-30", "materialName": "红泥", "defaultMaterial": 0, "factoryPriceTax": 100, 
 "involvesProcess": ["烧结"], "materialDetailMap": {"P": "0.21", "S": "0.2", "Lg": "9.5", "Zn": "0.044", "CaO": "11.88", "H2O": "25", "K2O": "0.223", "MgO": "1.57", "Na2O": "0.064", "SiO2": "2.28", "TiO2": "0.028", "Al2O3": "1.49"}}

{"id": "1465630809412538370", "sinter": 1, "freight": 11, "taxRate": 1.09, "shipName": "勿动！！！", "supplier": "22", "ironSmelt": 0, "pelletize": 0, "plantCode": "zhongsheng", "unitPrice": 1200, "categoryId": "5", "steelSmelt": 0, "categoryCode": "SOLID_FUEL", "materialDate": "2021-11-30", "materialName": "固体燃料", "defaultMaterial": 0, "factoryPriceTax": 1211.99, "involvesProcess": ["烧结"]}
{"id": "1463033656385736706", "valid": 0, "plantCode": "zhongsheng", "createTime": "2021-11-23T14:36:20", "detailList": [{"id": "1463033656398319623", "valid": 1, "ratioName": "billetIron", "createTime": "2021-11-23T14:36:20", "ratioValue": 98, "updateTime": "2021-11-23T14:36:20", "processDefinitionId": "1463033656385736706"}, {"id": "1463033656398319619", "valid": 1, "ratioName": "blastFurnaceIron", "createTime": "2021-11-23T14:36:20", "ratioValue": 0.5, "updateTime": "2021-11-23T14:36:20", "processDefinitionId": "1463033656385736706"}, {"id": "1463033656398319631", "valid": 1, "ratioName": "coalCoke", "createTime": "2021-11-23T14:36:20", "ratioValue": 85, "updateTime": "2021-11-23T14:36:20", "processDefinitionId": "1463033656385736706"}, {"id": "1463033656402513924", "valid": 1, "ratioName": "continuousCasting", "createTime": "2021-11-23T14:36:20", "ratioValue": 0.3, "updateTime": "2021-11-23T14:36:20", "processDefinitionId": "1463033656385736706"}, {"id": "1463033656398319620", "valid": 1, "ratioName": "converterIron", "createTime": "2021-11-23T14:36:20", "ratioValue": 7, "updateTime": "2021-11-23T14:36:20", "processDefinitionId": "1463033656385736706"}, {"id": "1463033656398319628", "valid": 1, "ratioName": "gradeIncreaseImpact", "createTime": "2021-11-23T14:36:20", "ratioValue": 1.25, "updateTime": "2021-11-23T14:36:20", "processDefinitionId": "1463033656385736706"}, {"id": "1463033656398319630", "valid": 1, "ratioName": "gradeMax", "createTime": "2021-11-23T14:36:20", "ratioValue": 60, "updateTime": "2021-11-23T14:36:20", "processDefinitionId": "1463033656385736706"}, {"id": "1463033656398319629", "valid": 1, "ratioName": "gradeMin", "createTime": "2021-11-23T14:36:20", "ratioValue": 53.5, "updateTime": "2021-11-23T14:36:20", "processDefinitionId": "1463033656385736706"}, {"id": "1463033656398319622", "valid": 1, "ratioName": "liquidIron", "createTime": "2021-11-23T14:36:20", "ratioValue": 94, "updateTime": "2021-11-23T14:36:20", "processDefinitionId": "1463033656385736706"}, {"id": "1463033656398319624", "valid": 1, "ratioName": "maxMaterialFeed", "createTime": "2021-11-23T14:36:20", "ratioValue": 9000, "updateTime": "2021-11-23T14:36:20", "processDefinitionId": "1463033656385736706"}, {"id": "1463033656394125313", "valid": 1, "ratioName": "mno", "createTime": "2021-11-23T14:36:20", "ratioValue": 70, "updateTime": "2021-11-23T14:36:20", "processDefinitionId": "1463033656385736706"}, {"id": "1463033656402513922", "valid": 1, "ratioName": "pelletizingDesulfuration", "createTime": "2021-11-23T14:36:20", "ratioValue": 85, "updateTime": "2021-11-23T14:36:20", "processDefinitionId": "1463033656385736706"}, {"id": "1463033656402513926", "valid": 1, "ratioName": "pelletizingReturnMine", "createTime": "2021-11-23T14:36:20", "ratioValue": 9, "updateTime": "2021-11-23T14:36:20", "processDefinitionId": "1463033656385736706"}, {"id": "1463033656398319626", "valid": 1, "ratioName": "referenceCoal", "createTime": "2021-11-23T14:36:20", "ratioValue": 145, "updateTime": "2021-11-30T15:38:33", "processDefinitionId": "1463033656385736706"}, {"id": "1463033656398319625", "valid": 1, "ratioName": "referenceCoke", "createTime": "2021-11-23T14:36:20", "ratioValue": 375, "updateTime": "2021-11-30T15:38:33", "processDefinitionId": "1463033656385736706"}, {"id": "1463033656398319627", "valid": 1, "ratioName": "referenceGrade", "createTime": "2021-11-23T14:36:20", "ratioValue": 57.5, "updateTime": "2021-11-23T14:36:20", "processDefinitionId": "1463033656385736706"}, {"id": "1463033656398319621", "valid": 1, "ratioName": "silicon", "createTime": "2021-11-23T14:36:20", "ratioValue": 0.3, "updateTime": "2021-11-23T14:36:20", "processDefinitionId": "1463033656385736706"}, {"id": "1463033656402513921", "valid": 1, "ratioName": "sinteringDesulfuration", "createTime": "2021-11-23T14:36:20", "ratioValue": 80, "updateTime": "2021-11-23T14:36:20", "processDefinitionId": "1463033656385736706"}, {"id": "1463033656402513925", "valid": 1, "ratioName": "sinteringReturnMine", "createTime": "2021-11-23T14:36:20", "ratioValue": 18, "updateTime": "2021-11-23T14:36:20", "processDefinitionId": "1463033656385736706"}, {"id": "1463033656398319618", "valid": 1, "ratioName": "slagImpurity", "createTime": "2021-11-23T14:36:20", "ratioValue": 2, "updateTime": "2021-11-23T14:36:20", "processDefinitionId": "1463033656385736706"}, {"id": "1463033656402513927", "valid": 1, "ratioName": "smeltingReturnMine", "createTime": "2021-11-23T14:36:20", "ratioValue": 15, "updateTime": "2021-11-23T14:36:20", "processDefinitionId": "1463033656385736706"}, {"id": "1463033656402513923", "valid": 1, "ratioName": "steelScrap", "createTime": "2021-11-23T14:36:20", "ratioValue": 2, "updateTime": "2021-11-23T14:36:20", "processDefinitionId": "1463033656385736706"}, {"id": "1463033656398319617", "valid": 1, "ratioName": "tio2", "createTime": "2021-11-23T14:36:20", "ratioValue": 25, "updateTime": "2021-11-23T14:36:20", "processDefinitionId": "1463033656385736706"}], "updateTime": "2021-11-24T18:28:47", "description": "真实数据，勿动", "particularYear": 2021, "productionName": "算法测试产品", "processConfigureModelList": [{"id": "1463033656415096834", "valid": 1, "createTime": "2021-11-23T14:36:20", "updateTime": "2021-11-23T14:36:20", "processType": 1, "processDefinitionId": "1463033656385736706", "constraintConfigureId": "1463026548743344130"}, {"id": "1463033656415096835", "valid": 1, "createTime": "2021-11-23T14:36:20", "updateTime": "2021-11-23T14:36:20", "processType": 2, "processDefinitionId": "1463033656385736706", "constraintConfigureId": "1463029244376387586"}, {"id": "1463033656415096836", "valid": 1, "createTime": "2021-11-23T14:36:20", "updateTime": "2021-11-23T14:36:20", "processType": 3, "processDefinitionId": "1463033656385736706", "constraintConfigureId": "1463032093227356162"}, {"id": "1463033656415096837", "valid": 1, "createTime": "2021-11-23T14:36:20", "updateTime": "2021-11-23T14:36:20", "processType": 4, "processDefinitionId": "1463033656385736706", "constraintConfigureId": "1463032325654712321"}, {"id": "1463033656415096838", "valid": 1, "createTime": "2021-11-23T14:36:20", "updateTime": "2021-11-23T14:36:20", "processType": 5, "processDefinitionId": "1463033656385736706"}]}
 MNO("mno", "MnO的回收率"),
    TIO2("tio2", "TiO2的回收率"),
    SLAG_IMPURITY("slagImpurity", "高炉炉渣杂质率"),
    BLAST_FURNACE_IRON("blastFurnaceIron", "高炉铁损耗"),
    CONVERTER_IRON("converterIron", "转炉铁损耗"),
    SILICON("silicon", "硅质量总占比"),
    LIQUID_IRON("liquidIron", "铁含量（铁水）"),
    BILLET_IRON("billetIron", "铁含量（钢坯）"),
    MAX_MATERIAL_FEED("maxMaterialFeed", "最大高炉原料投料量（顿/天）"),
    REFERENCE_COKE("referenceCoke", "基准焦比"),
    REFERENCE_COAL("referenceCoal", "基准媒比"),
    REFERENCE_GRADE("referenceGrade", "基准品位"),
    GRADE_INCREASE_IMPACT("gradeIncreaseImpact", "品位提升对燃料比影响"),
    GRADE_MIN("gradeMin", "高炉综合品位最小值"),
    GRADE_MAX("gradeMax", "高炉综合品位最大值"),
    COAL_COKE("coalCoke", "煤/焦碳比"),
    SINTERING_DESULFURATION("sinteringDesulfuration", "脱硫率（烧结）"),
    PELLETIZING_DESULFURATION("pelletizingDesulfuration", "脱硫率（球团）"),
    STEEL_SCRAP("steelScrap", "废钢杂质率"),
    CONTINUOUS_CASTING("continuousCasting", "连铸损耗率"),
    SINTERING_RETURN_MINE("sinteringReturnMine", "返矿率（烧结）"),
    PELLETIZING_RETURN_MINE("pelletizingReturnMine", "返矿率（球团）"),
    SMELTING_RETURN_MINE("smeltingReturnMine", "返矿率（炼铁）"),


-- 铁水1
select  (select ratio_value from process_definition_detail where process_definition_id='1462627752146243586' and ratio_name='maxMaterialFeed' and valid=1)*
(select ratio_value from process_definition_detail where process_definition_id='1462627752146243586' and ratio_name='gradeMax' and valid=1)/100*
(1-(select ratio_value from process_definition_detail where process_definition_id='1462627752146243586' and ratio_name='blastFurnaceIron' and valid=1)/100)/
((select ratio_value from process_definition_detail where process_definition_id='1462627752146243586' and ratio_name='liquidIron' and valid=1)/100)  from dual



*((1-(select ratio_value from process_definition_detail where process_definition_id='1462627752146243586' and ratio_name='converterIron' and valid=1)/100)*
((select ratio_value from process_definition_detail where process_definition_id='1462627752146243586' and ratio_name='liquidIron' and valid=1)/100)/
((select ratio_value from process_definition_detail where process_definition_id='1462627752146243586' and ratio_name='billetIron' and valid=1)/100)+
(select cc.upper_limit from process_configure pc left join  constraint_configure_detail cc  on  pc.constraint_configure_id=cc.constraint_configure_id where pc.process_definition_id='1462627752146243586' and pc.process_type=4)/100
*(1-(select ratio_value from process_definition_detail where process_definition_id='1462627752146243586' and ratio_name='steelScrap' and valid=1)/100)/
(1-(select cc.upper_limit from process_configure pc left join  constraint_configure_detail cc  on  pc.constraint_configure_id=cc.constraint_configure_id where pc.process_definition_id='1462627752146243586' and pc.process_type=4)/100)
)
14.21

CREATE TABLE `plan_history_material` (
  `id` bigint(20) NOT NULL COMMENT '主键',
  `purchase_plan_id` bigint(20) NOT NULL COMMENT '计划定义表id',
  `plan_result_code` varchar(64) COLLATE utf8mb4_bin DEFAULT NULL COMMENT '计划结果code',
  `material_id` bigint(20) NOT NULL COMMENT '原材料主表id',
  `category_id` bigint(20) NOT NULL COMMENT '原材料类型id',
  `material_type` int(1) NOT NULL DEFAULT '1' COMMENT '原材料分类：1主要原材料，2辅料，默认为1',
  `process_type` int(4) NOT NULL COMMENT '工序类型：1烧结，2球团，3炼铁，4炼钢',
  `material_name` varchar(32) COLLATE utf8mb4_bin NOT NULL COMMENT '原材料名称(品种)',
  `ship_name` varchar(32) COLLATE utf8mb4_bin NOT NULL COMMENT '船名',
  `supplier` varchar(32) COLLATE utf8mb4_bin NOT NULL COMMENT '供应商',
  `material_date` date NOT NULL COMMENT '日期',
  `material_unit_price` decimal(12,3) NOT NULL COMMENT '单价',
  `factory_price_tax` decimal(10,3) DEFAULT NULL COMMENT '到厂价含税（湿）',
  `tax_rate` decimal(12,3) NOT NULL COMMENT '税率',
  `grade` decimal(10,3) DEFAULT NULL COMMENT '品位',
  `used_qty` decimal(10,3) DEFAULT NULL COMMENT '使用吨数',
  `lower_limit` decimal(10,3) DEFAULT NULL COMMENT '下限',
  `upper_limit` decimal(10,3) DEFAULT NULL COMMENT '上限',
  `material_detail` json NOT NULL COMMENT '原材料详情',
  `valid` int(1) NOT NULL DEFAULT '1' COMMENT '状态：1有效，0无效，默认为1',
  `create_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`) USING BTREE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_bin COMMENT='计划历史输入原材料表';

CREATE TABLE `plan_history_input` (
  `id` bigint(20) NOT NULL COMMENT '主键',
  `purchase_plan_id` bigint(20) NOT NULL COMMENT '计划定义表id',
  `plan_result_code` varchar(64) COLLATE utf8mb4_bin DEFAULT NULL COMMENT '计划结果code',
  `process_definition` json NOT NULL COMMENT '工艺定义json',
  `material_strategy` json DEFAULT NULL COMMENT '品种策略json',
  `sinter_configure` json NOT NULL COMMENT '烧结json',
  `pelletize_configure` json NOT NULL COMMENT '球团json',
  `iron_smelt_configure` json NOT NULL COMMENT '炼铁json',
  `steel_smelt_configure` json NOT NULL COMMENT '炼钢json',
  `valid` int(1) NOT NULL DEFAULT '1' COMMENT '状态：1有效，0无效，默认为1',
  `create_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`) USING BTREE,
  UNIQUE KEY `index_plan_result` (`plan_result_code`) USING BTREE COMMENT '计划结果code 唯一索引'
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_bin COMMENT='计划历史输入表';

CREATE TABLE `purchase_plan` (
  `id` bigint(20) NOT NULL COMMENT '主键',
  `plant_code` varchar(64) COLLATE utf8mb4_bin NOT NULL COMMENT '工厂编码',
  `plan_name` varchar(64) COLLATE utf8mb4_bin NOT NULL COMMENT '计划名称',
  `plan_type` int(1) NOT NULL COMMENT '计划类型：1采购方案，2方案评估',
  `create_user_name` varchar(32) COLLATE utf8mb4_bin NOT NULL COMMENT '创建人用户账号',
  `update_user_name` varchar(32) COLLATE utf8mb4_bin NOT NULL COMMENT '最新更新人用户账号',
  `process_definition_id` bigint(20) NOT NULL COMMENT '工艺定义id',
  `production_name` varchar(64) COLLATE utf8mb4_bin DEFAULT NULL COMMENT '产品（工艺定义）名称',
  `material_strategy_id` bigint(20) DEFAULT NULL COMMENT '品种策略id',
  `product` int(1) DEFAULT NULL COMMENT '计量产物：1铁水，2钢坯，默认为1',
  `required_qty` decimal(12,3) DEFAULT NULL COMMENT '产量',
  `last_success_time` datetime DEFAULT NULL COMMENT '最后一次运行成功时间',
  `plan_status` int(1) NOT NULL DEFAULT '1' COMMENT '状态：1待编辑，2排队中，3运行中，4运行失败，5运行成功，6已取消，默认为1',
  `valid` int(1) NOT NULL DEFAULT '1' COMMENT '状态：1有效，0无效，默认为1',
  `create_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`) USING BTREE,
  UNIQUE KEY `index_plant_plan_name_type` (`plant_code`,`plan_name`,`plan_type`) USING BTREE COMMENT '工厂-计划名称-计划类型 唯一索引'
  
  CREATE TABLE `alg_steelmaking_result` (
  `id` int(11) unsigned NOT NULL AUTO_INCREMENT COMMENT '主键',
  `purchase_plan_id` bigint(20) NOT NULL COMMENT '采购计划id',
  `material_id` bigint(20) NOT NULL COMMENT '原材料主表id',
  `process_type` int(4) NOT NULL COMMENT '工序类型：1烧结，2球团，3炼铁，4炼钢',
  `input_mass` decimal(10,3) NOT NULL COMMENT '投入质量',
  `create_time` datetime DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`) USING BTREE,
  UNIQUE KEY `index_plan_material_tech` (`purchase_plan_id`,`material_id`,`process_type`) USING BTREE COMMENT '采购计划id-原材料-工序类型 唯一索引'
) ENGINE=InnoDB AUTO_INCREMENT=854 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_bin COMMENT='炼钢算法输出表';
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_bin COMMENT='计划定义表';

CREATE TABLE `process_definition` (
  `id` bigint(20) NOT NULL COMMENT '主键',
  `plant_code` varchar(64) COLLATE utf8mb4_bin NOT NULL COMMENT '工厂编码',
  `production_name` varchar(64) COLLATE utf8mb4_bin NOT NULL COMMENT '产品名称',
  `description` varchar(64) COLLATE utf8mb4_bin NOT NULL COMMENT '工艺描述',
  `particular_year` int(4) NOT NULL COMMENT '年份',
  `valid` int(1) NOT NULL DEFAULT '1' COMMENT '状态：1有效，0无效，默认为1',
  `create_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`) USING BTREE,
  UNIQUE KEY `index_plant_prodution_year` (`plant_code`,`production_name`,`particular_year`) USING BTREE COMMENT '工厂-产品名称-年份 唯一索引'
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_bin COMMENT='工艺定义';

CREATE TABLE `process_definition_detail` (
  `id` bigint(20) NOT NULL COMMENT '主键',
  `process_definition_id` bigint(20) NOT NULL COMMENT '工艺定义id',
  `ratio_name` varchar(64) COLLATE utf8mb4_bin NOT NULL COMMENT '名称',
  `ratio_value` decimal(10,3) NOT NULL COMMENT '值',
  `valid` int(1) NOT NULL DEFAULT '1' COMMENT '状态：1有效，0无效，默认为1',
  `create_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`) USING BTREE,
  UNIQUE KEY `index_process_definition_ratio_name` (`process_definition_id`,`ratio_name`) USING BTREE COMMENT '工艺定义id-名称 唯一索引'
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_bin COMMENT='工艺定义详情';
  
  CREATE TABLE `constraint_configure_detail` (
  `id` bigint(20) NOT NULL COMMENT '主键',
  `constraint_configure_id` bigint(20) NOT NULL COMMENT '约束配置id',
  `target_one` varchar(64) COLLATE utf8mb4_bin NOT NULL COMMENT '对象1',
  `target_two` varchar(64) COLLATE utf8mb4_bin DEFAULT NULL COMMENT '对象2',
  `lower_limit` decimal(10,3) DEFAULT NULL COMMENT '下限',
  `upper_limit` decimal(10,3) DEFAULT NULL COMMENT '上限',
  `valid` int(1) NOT NULL DEFAULT '1' COMMENT '状态：1有效，0无效，默认为1',
  `create_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`) USING BTREE,
  UNIQUE KEY `index_constraint_configure_target` (`constraint_configure_id`,`target_one`,`target_two`) USING BTREE COMMENT '约束配置id-对象 唯一索引'
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_bin COMMENT='约束配置详情';
  
  CREATE TABLE `plan_history_input_constraint` (
  `id` bigint(20) NOT NULL COMMENT '主键',
  `plan_result_code` varchar(64) COLLATE utf8mb4_bin DEFAULT NULL COMMENT '计划结果code',
  `constraint_type` int(4) NOT NULL COMMENT '约束类型：1烧结，2球团，3炼铁，4炼钢',
  `constraint_desc` varchar(64) COLLATE utf8mb4_bin NOT NULL COMMENT '约束说明',
  `constraint_key` varchar(64) COLLATE utf8mb4_bin NOT NULL COMMENT '约束key',
  `constraint_value` decimal(10,3) NOT NULL COMMENT '实际值',
  `lower_limit` decimal(10,3) DEFAULT NULL COMMENT '下限',
  `upper_limit` decimal(10,3) DEFAULT NULL COMMENT '上限',
  `satisfy_flag` int(1) NOT NULL DEFAULT '1' COMMENT '是否符合情况：1符合，2不符合，默认为1',
  `valid` int(1) NOT NULL DEFAULT '1' COMMENT '状态：1有效，0无效，默认为1',
  `create_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`) USING BTREE,
  UNIQUE KEY `index_plan_result_constraint` (`plan_result_code`,`constraint_type`,`constraint_key`) USING BTREE COMMENT '计划结果code-约束类型-约束key 唯一索引'
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_bin COMMENT='计划历史输入约束表';



select wk1.* case when ratio_name= from 

select "烧结",phi.purchase_plan_id,phi.plan_result_code,TRIM(BOTH '"' from JSON_EXTRACT(phi.process_definition, '$.processConfigureModelList[0].processDefinitionId')), ccd.constraint_configure_id,ccd.target_one,ccd.target_two,ccd.lower_limit,ccd.upper_limit from 
plan_history_input phi left join constraint_configure_detail ccd  on ccd.constraint_configure_id=TRIM(BOTH '"' from JSON_EXTRACT(phi.process_definition, '$.processConfigureModelList[0].constraintConfigureId')) 
union
select "球团",phi.purchase_plan_id,phi.plan_result_code,TRIM(BOTH '"' from JSON_EXTRACT(phi.process_definition, '$.processConfigureModelList[1].processDefinitionId')), ccd.constraint_configure_id,ccd.target_one,ccd.target_two,ccd.lower_limit,ccd.upper_limit from 
plan_history_input phi left join constraint_configure_detail ccd  on ccd.constraint_configure_id=TRIM(BOTH '"' from JSON_EXTRACT(phi.process_definition, '$.processConfigureModelList[1].constraintConfigureId'))
union
select "炼铁",phi.purchase_plan_id,phi.plan_result_code,TRIM(BOTH '"' from JSON_EXTRACT(phi.process_definition, '$.processConfigureModelList[2].processDefinitionId')), ccd.constraint_configure_id,ccd.target_one,ccd.target_two,ccd.lower_limit,ccd.upper_limit from 
plan_history_input phi left join constraint_configure_detail ccd  on ccd.constraint_configure_id=TRIM(BOTH '"' from JSON_EXTRACT(phi.process_definition, '$.processConfigureModelList[2].constraintConfigureId'))
union
select "炼钢",phi.purchase_plan_id,phi.plan_result_code,TRIM(BOTH '"' from JSON_EXTRACT(phi.process_definition, '$.processConfigureModelList[3].processDefinitionId')), ccd.constraint_configure_id,ccd.target_one,ccd.target_two,ccd.lower_limit,ccd.upper_limit from 
plan_history_input phi left join constraint_configure_detail ccd  on ccd.constraint_configure_id=TRIM(BOTH '"' from JSON_EXTRACT(phi.process_definition, '$.processConfigureModelList[3].constraintConfigureId'))

plan_history_input


select wk3.*,phic.upper_limit as uplimt from
(
select cc.constraint_name, wk2.* from (select pp.plan_name,wk1.* from 
(
select 1,phi.purchase_plan_id,phi.plan_result_code,TRIM(BOTH '"' from JSON_EXTRACT(phi.process_definition, '$.processConfigureModelList[0].processDefinitionId')), ccd.constraint_configure_id,ccd.target_one,ccd.target_two,ccd.lower_limit,ccd.upper_limit from 
plan_history_input phi left join constraint_configure_detail ccd  on ccd.constraint_configure_id=TRIM(BOTH '"' from JSON_EXTRACT(phi.process_definition, '$.processConfigureModelList[0].constraintConfigureId')) 
union
select 2,phi.purchase_plan_id,phi.plan_result_code,TRIM(BOTH '"' from JSON_EXTRACT(phi.process_definition, '$.processConfigureModelList[1].processDefinitionId')), ccd.constraint_configure_id,ccd.target_one,ccd.target_two,ccd.lower_limit,ccd.upper_limit from 
plan_history_input phi left join constraint_configure_detail ccd  on ccd.constraint_configure_id=TRIM(BOTH '"' from JSON_EXTRACT(phi.process_definition, '$.processConfigureModelList[1].constraintConfigureId'))
union
select 3,phi.purchase_plan_id,phi.plan_result_code,TRIM(BOTH '"' from JSON_EXTRACT(phi.process_definition, '$.processConfigureModelList[2].processDefinitionId')), ccd.constraint_configure_id,ccd.target_one,ccd.target_two,ccd.lower_limit,ccd.upper_limit from 
plan_history_input phi left join constraint_configure_detail ccd  on ccd.constraint_configure_id=TRIM(BOTH '"' from JSON_EXTRACT(phi.process_definition, '$.processConfigureModelList[2].constraintConfigureId'))
union
select 4,phi.purchase_plan_id,phi.plan_result_code,TRIM(BOTH '"' from JSON_EXTRACT(phi.process_definition, '$.processConfigureModelList[3].processDefinitionId')), ccd.constraint_configure_id,ccd.target_one,ccd.target_two,ccd.lower_limit,ccd.upper_limit from 
plan_history_input phi left join constraint_configure_detail ccd  on ccd.constraint_configure_id=TRIM(BOTH '"' from JSON_EXTRACT(phi.process_definition, '$.processConfigureModelList[3].constraintConfigureId'))
) wk1 left join purchase_plan pp on pp.id=wk1.purchase_plan_id where pp.valid=1) wk2 left join constraint_configure cc on cc.id=wk2.constraint_configure_id
) wk3 ,plan_history_input_constraint phic where phic.plan_result_code=wk3.plan_result_code and phic.constraint_type=wk3.1 and phic.constraint_key=(case when wk3.target_two is not null then CONCAT_WS('/',wk3.target_one,wk3.target_two) else wk3.target_one end)

select phi.purchase_plan_id,phi.plan_result_code,phm.material_id,phm.material_name,phm.used_qty  from  
plan_history_input phi left join plan_history_material phm on 
phm.plan_result_code=phi.plan_result_code and 
phm.purchase_plan_id=phi.purchase_plan_id




select phm.process_type,phi.purchase_plan_id,phi.plan_result_code,
SUM(phm.used_qty*
(1-(IFNULL(TRIM(BOTH '"' from JSON_EXTRACT(phm.material_detail, '$.materialDetailMap.H2O')),0))/100)*
((IFNULL(TRIM(BOTH '"' from JSON_EXTRACT(phm.material_detail, '$.materialDetailMap.S')),0))/100))*
(1-
(IFNULL(
(TRIM(BOTH '"' from (
JSON_EXTRACT(
phi.process_definition, 
TRIM(
BOTH '"' from (
replace(
JSON_SEARCH(phi.process_definition,'one','sinteringDesulfuration'),'ratioName','ratiovalue'
)
)
)
)
)
)
)
/100),0
))
from  
plan_history_input phi left join plan_history_material phm on 
phm.plan_result_code=phi.plan_result_code and 
phm.purchase_plan_id=phi.purchase_plan_id
group by phm.purchase_plan_id,phm.plan_result_code,phm.process_type


-- 烧结/球团中物质S质量比计算 start ---------- 公式7
select phm.process_type,phi.purchase_plan_id,phi.plan_result_code,
-- 烧结/球团中物质S质量计算 start ---------- 公式5
(SUM(phm.used_qty*
-- 在查找对应原材料库中S/H2O的占比
(1-(IFNULL(JSON_UNQUOTE(JSON_EXTRACT(phm.material_detail, '$.materialDetailMap.H2O')),0))/100)*
((IFNULL(JSON_UNQUOTE(JSON_EXTRACT(phm.material_detail, '$.materialDetailMap.S')),0))/100)))*
(1-
-- 根据不同工序查找不同的脱硫率--
(case when phm.process_type=1 then
          (IFNULL((JSON_UNQUOTE(JSON_EXTRACT(phi.process_definition, REPLACE((JSON_UNQUOTE(JSON_SEARCH(process_definition,'one','sinteringDesulfuration',NULL,'$**.ratioName'))),"ratioName","ratioValue")))),0)/100)
      when phm.process_type=2 then
          (IFNULL((JSON_UNQUOTE(JSON_EXTRACT(phi.process_definition, REPLACE((JSON_UNQUOTE(JSON_SEARCH(process_definition,'one','pelletizingDesulfuration',NULL,'$**.ratioName'))),"ratioName","ratioValue")))),0)/100)
	  else 0 end)
)/
-- 烧结/球团中物质S质量计算 END ---------- 公式5
-- 烧结/球团高炉投入量      START ---------- 公式12
(SUM(phm.used_qty*
(1-(IFNULL(JSON_UNQUOTE(JSON_EXTRACT(phm.material_detail, '$.materialDetailMap.Lg')),0))/100)*
(1-(IFNULL(JSON_UNQUOTE(JSON_EXTRACT(phm.material_detail, '$.materialDetailMap.H2O')),0))/100))*
-- 根据不同工序查找不同的反矿率--
(1-
(case when phm.process_type=1 then
           (IFNULL((JSON_UNQUOTE(JSON_EXTRACT(phi.process_definition, REPLACE((JSON_UNQUOTE(JSON_SEARCH(process_definition,'one','sinteringReturnMine',NULL,'$**.ratioName'))),"ratioName","ratioValue")))),0)/100)
      when phm.process_type=2 then
          (IFNULL((JSON_UNQUOTE(JSON_EXTRACT(phi.process_definition, REPLACE((JSON_UNQUOTE(JSON_SEARCH(process_definition,'one','pelletizingReturnMine',NULL,'$**.ratioName'))),"ratioName","ratioValue")))),0)/100)
      else 0 end)))*100
-- 烧结/球团高炉投入量      END ----------  公式12
from  
plan_history_input phi left join plan_history_material phm on 
phm.plan_result_code=phi.plan_result_code and 
phm.purchase_plan_id=phi.purchase_plan_id
where phm.process_type in (1,2)
group by phm.purchase_plan_id,phm.plan_result_code,phm.process_type
-- 烧结/球团s质量比计算 end ----------  公式7

-- 烧结/球团中物质P质量比计算 start ---------- 公式7
select phm.process_type,phi.purchase_plan_id,phi.plan_result_code,
-- 烧结/球团中物质P质量计算 start ---------- 公式6
(SUM(phm.used_qty*
-- 在查找对应原材料库中S/H2O的占比
(1-(IFNULL(JSON_UNQUOTE(JSON_EXTRACT(phm.material_detail, '$.materialDetailMap.H2O')),0))/100)*
((IFNULL(JSON_UNQUOTE(JSON_EXTRACT(phm.material_detail, '$.materialDetailMap.P')),0))/100)))
/
-- 烧结/球团中物质P质量计算 END ---------- 公式6
-- 烧结/球团高炉投入量      START ---------- 公式12
-- 烧结/球团矿产出量        START ---------- 公式11
(SUM(phm.used_qty*
(1-(IFNULL(JSON_UNQUOTE(JSON_EXTRACT(phm.material_detail, '$.materialDetailMap.Lg')),0))/100)*
(1-(IFNULL(JSON_UNQUOTE(JSON_EXTRACT(phm.material_detail, '$.materialDetailMap.H2O')),0))/100))*
-- 烧结/球团矿产出量        END   ---------- 公式11
-- 根据不同工序查找不同的反矿率--
(1-
(case when phm.process_type=1 then
           (IFNULL((JSON_UNQUOTE(JSON_EXTRACT(phi.process_definition, REPLACE((JSON_UNQUOTE(JSON_SEARCH(process_definition,'one','sinteringReturnMine',NULL,'$**.ratioName'))),"ratioName","ratioValue")))),0)/100)
      when phm.process_type=2 then
          (IFNULL((JSON_UNQUOTE(JSON_EXTRACT(phi.process_definition, REPLACE((JSON_UNQUOTE(JSON_SEARCH(process_definition,'one','pelletizingReturnMine',NULL,'$**.ratioName'))),"ratioName","ratioValue")))),0)/100)
      else 0 end)))*100
-- 烧结/球团高炉投入量      END ----------  公式12
from  
plan_history_input phi left join plan_history_material phm on 
phm.plan_result_code=phi.plan_result_code and 
phm.purchase_plan_id=phi.purchase_plan_id
where phm.process_type in (1,2)
group by phm.purchase_plan_id,phm.plan_result_code,phm.process_type
-- 烧结/球团P质量比计算 end ----------  公式7